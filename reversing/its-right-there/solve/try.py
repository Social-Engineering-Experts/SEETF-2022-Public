import struct
import os

# Partially parsed orig_ps30.bin to get the constants
config = {
    396: ('c5', 
        ('0.578267335892', '0.0722834169865', '7.99900007248', '0.125')),
    420: ('c6', 
        ('-8.0', '-9.0', '-10.0', '-11.0')),
    444: ('c7', 
        ('-12.0', '-13.0', '-14.0', '-15.0')),
    468: ('c8', 
        ('-16.0', '-17.0', '-18.0', '-19.0')),
    492: ('c9', 
        ('-20.0', '-21.0', '-22.0', '-23.0')),
    516: ('c10',
         ('0.0', '1.0', '0.0010000000475', '-0.800999999046')),
    540: ('c11',
         ('81.2772903442', '0.0', '0.899999976158', '-0.34999999404')),  
    564: ('c12',
         ('6.28318548203', '-3.14159274101', '0.0', '-0.0299999993294')),
    588: ('c13',
         ('-4.0', '-5.0', '-6.0', '-7.0')),
    612: ('c14',
         ('-24.0', '-25.0', '-26.0', '-27.0')),
    636: ('c15',
         ('0.5', '50.0', '2.0', '0.159154936671')), # Modified c15.y, 5->50
    660: ('c16',
         ('-0.0', '-1.0', '-2.0', '-3.0')),
    684: ('c17',
         ('0.5', '0.40000000596', '-0.800000011921', '1.10000002384')),  
    708: ('c18',
        ('-67.442855835', '12.1051282883', '-0.600000023842', '-0.550000011921')),  
    732: ('c19', 
        ('0.125', '0.875', '0.5', '-0.0500000007451')),
    756: ('c20',
        ('1.25', '-0.10000000149', '-0.0010000000475', '-0.101000003517')),
    780: ('c21', 
        ('-0.5', '-1.04716670513', '1.04716670513', '-20.0')), # Modified c21.w, -3.0 -> -20
    804: ('c22',
        ('0.00999999977648', '0.0500000007451', '0.070000000298', '0.0')),
    828: ('c23',
        ('0.199999988079', '-0.699999988079', '0.300000011921', '0.333333343267')), 
    852: ('c24', 
        ('4.0', '0.40000000596', '1.20000004768', '0.00999999977648')), 
    876: ('c25', 
        ('0.179999992251', '0.216000005603', '0.324000000954', '0.0')), 
    900: ('c26', 
        ('0.899999976158', '1.08000004292', '1.62000000477', '0.0')),   
    924: ('c27',
        ('0.318309903145', '2.60000014305', '3.40000009537', '1.59154939651')),     
    948: ('c28',
        ('11.4000005722', '9.4000005722', '0.0159154944122', '-0.070000000298')),   
    972: ('c29', 
        ('0.5', '0.40000000596', '-0.800000011921', '1.09899997711')),  
    996: ('c30',
        ('0.500999987125', '-0.799000024796', '100', '0.499000012875')), # Modified c30.z 1.10000002384 -> 100
    1020: ('c31',
        ('0.400999993086', '1.10100007057', '0.398999989033', '0.00300000002608')),
    1044: ('c32', 
        ('0.629999995232', '0.756000041962', '1.13399994373', '2.5')),
    1068: ('c33', 
        ('4.5', '5.40000009537', '8.10000038147', '0.0')),
    1092: ('c34', 
        ('0.0', '-0.0010000000475', '-2.0', '0.0')), # Modified c34.w 3 -> 0
    1116: ('c35', 
        ('0.20000000298', '0.800000011921', '0.0', '0.0')),
    1140: ('c36', 
        ('-1.0', '0.0', '1.0', '0.019999999553')),
    1164: ('c37',
        ('-20.7516479492', '8.64651966095', '-15.5637359619', '38.0446891785')),
    1188: ('c38',
        ('-57.0670318604', '103.758239746', '-84.7358932495', '-17.2930393219')),
    1212: ('c39',
        ('-29.3981685638', '65.7135543823', '-44.9619026184', '95.1117172241')),
    1236: ('c40', 
        ('-77.8186798096', '0.0', '70.9014663696', '13.8344316483')),
    1260: ('c41',
        ('-3.45860791206', '-34.5860786438', '6.91721582413', '-10.3758239746')),
    1284: ('c42',
        ('0.5', '0.500999987125', '0.40000000596', '0.499000012875')),
    1308: ('i0', 
        ('200', '0', '0', '0')),
    1332: ('i1', 
        ('28', '0', '0', '0'))
}

def apply_config(config):

    return "\n".join([
        'set {char [16]} %s = ' % hex(0x421FD0 + o) + \
        '{%s}'% ",".join(
            r"0x"+format(i, "02x") for i in (
                struct.pack("<ffff", *map(float, v)) if r[0] == "c" else
                struct.pack("<iiii", *map(int, v))
            )
        )
        for o, (r, v) in config.items()
    ])

def write_config(str):
    open("gdb_input", "w").write(str)

def run():
    os.system("(type gdb_input && cat) | gdb Its-Right-There.exe")

write_config("\n".join([
    "b *0x004000D3", # Just before unpack
    "r", # Unpack!

    "b *0x00420314", # push address of pixel shader to stack
    "c", # Run!

    apply_config(config),

    "c", # Run!
    ""
]))

run()